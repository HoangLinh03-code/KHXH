# @format

name: Build & Release Windows App

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      # CÀI ĐẶT PANDOC ĐẦY ĐỦ (bao gồm dependencies)
      - name: Install Pandoc with Dependencies
        shell: pwsh
        run: |
          # Cài Pandoc qua Chocolatey (bản stable có đầy đủ DLL)
          choco install pandoc --version=3.1.11 --no-progress -y

          # Verify installation
          $pandocPath = (Get-Command pandoc).Source
          Write-Host "Pandoc installed at: $pandocPath"

          # Test pandoc hoạt động
          pandoc --version

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        shell: pwsh
        run: |
          pip install PyQt5 PyQt5-Qt5 PyQt5_sip PyQtWebEngine PyQtWebEngine-Qt5
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Create .env file
        shell: pwsh
        run: |
          Set-Content -Path ".env" -Value $env:ENV_KEY_CONTENT -NoNewline
        env:
          ENV_KEY_CONTENT: ${{ secrets.ENV_KEY }}

      # BUILD VỚI CẤU HÌNH TỐI ƯU
      - name: Build with PyInstaller
        shell: pwsh
        run: |
          python -m PyInstaller `
            --onefile `
            --clean `
            --noconfirm `
            --name ToolGen `
            --add-data ".env;." `
            --add-data "api;api" `
            --add-data "process;process" `
            GenQues.py

      # ĐÓNG GÓI PANDOC ĐẦY ĐỦ
      - name: Prepare Package with Pandoc
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "GenQues" -Force

          # Copy file EXE chính
          Copy-Item -Path "dist/ToolGen.exe" -Destination "GenQues/"

          # Copy các file Prompt
          Copy-Item -Path "testDS.txt" -Destination "GenQues/" -ErrorAction SilentlyContinue
          Copy-Item -Path "testTN.txt" -Destination "GenQues/" -ErrorAction SilentlyContinue
          Copy-Item -Path "testTLN.txt" -Destination "GenQues/" -ErrorAction SilentlyContinue

          # [QUAN TRỌNG] Tìm và copy Pandoc
          Write-Host "Searching for Pandoc installation..."

          # Tìm Pandoc exe
          $pandocExe = (Get-Command pandoc -ErrorAction SilentlyContinue).Source

          if (-not $pandocExe) {
              # Fallback: Tìm trong các đường dẫn phổ biến
              $possiblePaths = @(
                  "C:\ProgramData\chocolatey\lib\pandoc\tools\pandoc.exe",
                  "$env:LOCALAPPDATA\Pandoc\pandoc.exe",
                  "$env:APPDATA\local\Pandoc\pandoc.exe"
              )
              
              foreach ($path in $possiblePaths) {
                  if (Test-Path $path) {
                      $pandocExe = $path
                      break
                  }
              }
          }

          if (-not $pandocExe) {
              Write-Error "Cannot find Pandoc installation!"
              exit 1
          }

          $pandocDir = Split-Path -Parent $pandocExe
          Write-Host "Found Pandoc at: $pandocDir"

          # Tạo thư mục pandoc trong GenQues
          New-Item -ItemType Directory -Path "GenQues/pandoc" -Force

          # Copy TẤT CẢ files từ thư mục Pandoc
          Copy-Item -Path "$pandocDir\*" -Destination "GenQues/pandoc/" -Recurse -Force

          # Verify copy thành công
          Write-Host "Pandoc files copied:"
          Get-ChildItem "GenQues/pandoc" -Recurse | Format-Table Name, Length -AutoSize

          # Kiểm tra pandoc.exe có tồn tại không
          if (Test-Path "GenQues/pandoc/pandoc.exe") {
              Write-Host "pandoc.exe verified in package"
          } else {
              Write-Error "pandoc.exe NOT found in package!"
              exit 1
          }

      - name: Zip Release
        shell: pwsh
        run: |
          $tagName = "${{ github.ref_name }}"
          $zipName = "GenQues-$tagName.zip"
          Compress-Archive -Path "GenQues" -DestinationPath $zipName
          echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ZIP_NAME }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
